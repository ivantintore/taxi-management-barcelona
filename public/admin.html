<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administraci√≥n - Taxi BCN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin-bottom: 10px;
        }

        .back-btn {
            background: #c0392b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .back-btn:hover {
            background: #a93226;
        }

        .nav-tabs {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: #2c3e50;
        }

        .nav-tab.active {
            background: #3498db;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card.income {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .stat-card.expense {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #ecf0f1;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #d5dbdb;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .file-input {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #fadbd8;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">‚Üê Volver</button>
            <h1>üëë Panel de Administraci√≥n</h1>
            <p id="adminInfo">Elena Fontelles - Administradora</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('jornadas')">üìÖ Jornadas</button>
            <button class="nav-tab" onclick="showTab('liquidaciones')">üí∞ Liquidaciones</button>
            <button class="nav-tab" onclick="showTab('cierre-mensual')">üìà Cierre Mensual</button>
            <button class="nav-tab" onclick="showTab('usuarios')">üë• Usuarios</button>
            <button class="nav-tab" onclick="showTab('reportes')">üìã Reportes</button>
        </div>

        <div class="content">
            <div id="message" class="hidden"></div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTaxis">3</div>
                        <div class="stat-label">Taxis Activos</div>
                    </div>
                    <div class="stat-card income">
                        <div class="stat-number" id="recaudacionMes">‚Ç¨ 0</div>
                        <div class="stat-label">Recaudaci√≥n del Mes</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-number" id="gastosMes">‚Ç¨ 0</div>
                        <div class="stat-label">Gastos del Mes</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number" id="jornadasPendientes">0</div>
                        <div class="stat-label">Jornadas Hoy</div>
                    </div>
                </div>

                <div class="section">
                    <h3>üìä Resumen por Taxista</h3>
                    <div id="resumenTaxistas">
                        <p>Cargando datos...</p>
                    </div>
                </div>
            </div>

            <!-- Jornadas Tab -->
            <div id="jornadas" class="tab-content">
                <div class="section">
                    <h3>üìÖ Registro de Jornadas Laborales</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="filtroFechaJornada">Filtrar por fecha</label>
                            <input type="date" id="filtroFechaJornada" onchange="loadJornadas()">
                        </div>
                        <div class="form-group">
                            <label for="filtroTaxistaJornada">Filtrar por taxista</label>
                            <select id="filtroTaxistaJornada" onchange="loadJornadas()">
                                <option value="">Todos los taxistas</option>
                                <option value="361">Raul Maraver (361)</option>
                                <option value="1061">Ivan Alsina (1061)</option>
                                <option value="092">Salvador Carmona (092)</option>
                            </select>
                        </div>
                    </div>
                    <div id="jornadasTable"></div>
                </div>
            </div>

            <!-- Liquidaciones Tab -->
            <div id="liquidaciones" class="tab-content">
                <div class="section">
                    <h3>üí∞ Liquidaciones Diarias</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="filtroFechaLiq">Filtrar por fecha</label>
                            <input type="date" id="filtroFechaLiq" onchange="loadLiquidaciones()">
                        </div>
                        <div class="form-group">
                            <label for="filtroTaxistaLiq">Filtrar por taxista</label>
                            <select id="filtroTaxistaLiq" onchange="loadLiquidaciones()">
                                <option value="">Todos los taxistas</option>
                                <option value="361">Raul Maraver (361)</option>
                                <option value="1061">Ivan Alsina (1061)</option>
                                <option value="092">Salvador Carmona (092)</option>
                            </select>
                        </div>
                    </div>
                    <div id="liquidacionesTable"></div>
                </div>
            </div>

            <!-- Cierre Mensual Tab -->
            <div id="cierre-mensual" class="tab-content">
                <div class="section">
                    <h3>üìà Cierre Mensual</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mescierre">Mes</label>
                            <select id="mescierre" required>
                                <option value="">Seleccionar mes</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="a√±ocierre">A√±o</label>
                            <select id="a√±ocierre" required>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taxistaCierre">Taxista</label>
                            <select id="taxistaCierre" required>
                                <option value="">Seleccionar taxista</option>
                                <option value="1">Raul Maraver (361)</option>
                                <option value="2">Ivan Alsina (1061)</option>
                                <option value="3">Salvador Carmona (092)</option>
                            </select>
                        </div>
                    </div>

                    <div class="upload-area" onclick="document.getElementById('archivosInput').click()">
                        <h4>üìÅ Subir Archivos para Cierre</h4>
                        <p>Haz clic aqu√≠ o arrastra los archivos Excel</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                            Archivos necesarios: Banco, Freenow, Uber
                        </p>
                        <input type="file" id="archivosInput" class="file-input" multiple accept=".xlsx,.xls">
                    </div>

                    <div id="archivosSubidos" class="hidden">
                        <h4>Archivos seleccionados:</h4>
                        <ul id="listaArchivos"></ul>
                    </div>

                    <button type="button" class="btn btn-success" onclick="procesarCierre()" id="procesarBtn">
                        üßÆ Procesar Cierre Mensual
                    </button>

                    <div id="resultadoCierre" class="hidden section">
                        <h3>üìä Resultado del Cierre</h3>
                        <div id="detallesCierre"></div>
                    </div>
                </div>
            </div>

            <!-- Usuarios Tab -->
            <div id="usuarios" class="tab-content">
                <div class="section">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <div id="usuariosTable"></div>
                </div>
            </div>

            <!-- Reportes Tab -->
            <div id="reportes" class="tab-content">
                <div class="section">
                    <h3>üìã Reportes y Estad√≠sticas</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipoReporte">Tipo de Reporte</label>
                            <select id="tipoReporte">
                                <option value="mensual">Resumen Mensual</option>
                                <option value="anual">Resumen Anual</option>
                                <option value="taxista">Por Taxista</option>
                                <option value="comparativo">Comparativo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fechaInicioReporte">Fecha Inicio</label>
                            <input type="date" id="fechaInicioReporte">
                        </div>
                        <div class="form-group">
                            <label for="fechaFinReporte">Fecha Fin</label>
                            <input type="date" id="fechaFinReporte">
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="generarReporte()">
                        üìä Generar Reporte
                    </button>

                    <div id="reporteResultado" class="hidden section">
                        <h3>üìà Resultado del Reporte</h3>
                        <div id="contenidoReporte"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Inicializar p√°gina
        window.onload = async function() {
            await checkAuth();
            loadDashboard();
            setupEventListeners();
        };

        async function checkAuth() {
            try {
                const response = await fetch('/api/dashboard');
                if (!response.ok) {
                    window.location.href = '/';
                    return;
                }
                
                const data = await response.json();
                currentUser = data.user;
                
                if (currentUser.tipo !== 'admin') {
                    showMessage('Acceso denegado. Solo administradores pueden acceder a esta p√°gina.', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                    return;
                }
                
                document.getElementById('adminInfo').textContent = 
                    `${currentUser.nombre} - Administradora`;
            } catch (error) {
                window.location.href = '/';
            }
        }

        function setupEventListeners() {
            // Configurar drag & drop para archivos
            const uploadArea = document.querySelector('.upload-area');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            document.getElementById('archivosInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Cargar datos espec√≠ficos de la pesta√±a
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'jornadas':
                    loadJornadas();
                    break;
                case 'liquidaciones':
                    loadLiquidaciones();
                    break;
                case 'usuarios':
                    loadUsuarios();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                // Cargar estad√≠sticas del dashboard
                const [jornadasRes, liquidacionesRes] = await Promise.all([
                    fetch('/api/jornadas'),
                    fetch('/api/liquidaciones')
                ]);

                if (jornadasRes.ok && liquidacionesRes.ok) {
                    const jornadas = await jornadasRes.json();
                    const liquidaciones = await liquidacionesRes.json();

                    // Actualizar estad√≠sticas
                    updateDashboardStats(jornadas, liquidaciones);
                    updateResumenTaxistas(liquidaciones);
                }
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        function updateDashboardStats(jornadas, liquidaciones) {
            const hoy = new Date().toISOString().split('T')[0];
            const inicioMes = new Date();
            inicioMes.setDate(1);
            const inicioMesStr = inicioMes.toISOString().split('T')[0];

            // Jornadas de hoy
            const jornadasHoy = jornadas.filter(j => j.fecha === hoy).length;
            document.getElementById('jornadasPendientes').textContent = jornadasHoy;

            // Liquidaciones del mes
            const liquidacionesMes = liquidaciones.filter(l => l.fecha >= inicioMesStr);
            const recaudacionMes = liquidacionesMes.reduce((sum, l) => sum + parseFloat(l.recaudacion || 0), 0);
            const gastosMes = liquidacionesMes.reduce((sum, l) => 
                sum + parseFloat(l.combustible || 0) + parseFloat(l.gas || 0) + parseFloat(l.otros_gastos || 0), 0);

            document.getElementById('recaudacionMes').textContent = `‚Ç¨ ${recaudacionMes.toFixed(2)}`;
            document.getElementById('gastosMes').textContent = `‚Ç¨ ${gastosMes.toFixed(2)}`;
        }

        function updateResumenTaxistas(liquidaciones) {
            const taxistas = {
                '361': { nombre: 'Raul Maraver', recaudacion: 0, liquidaciones: 0 },
                '1061': { nombre: 'Ivan Alsina', recaudacion: 0, liquidaciones: 0 },
                '092': { nombre: 'Salvador Carmona', recaudacion: 0, liquidaciones: 0 }
            };

            liquidaciones.forEach(l => {
                if (taxistas[l.licencia]) {
                    taxistas[l.licencia].recaudacion += parseFloat(l.recaudacion || 0);
                    taxistas[l.licencia].liquidaciones++;
                }
            });

            let html = '<div class="stats-grid">';
            Object.entries(taxistas).forEach(([licencia, data]) => {
                html += `
                    <div class="stat-card">
                        <div class="stat-number">‚Ç¨ ${data.recaudacion.toFixed(2)}</div>
                        <div class="stat-label">${data.nombre} (${licencia})</div>
                        <small>${data.liquidaciones} liquidaciones</small>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('resumenTaxistas').innerHTML = html;
        }

        async function loadJornadas() {
            try {
                const response = await fetch('/api/jornadas');
                if (response.ok) {
                    const jornadas = await response.json();
                    displayJornadas(jornadas);
                }
            } catch (error) {
                console.error('Error cargando jornadas:', error);
            }
        }

        function displayJornadas(jornadas) {
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Taxista</th>
                            <th>Licencia</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                            <th>Horas Efectivas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            jornadas.forEach(jornada => {
                html += `
                    <tr>
                        <td>${jornada.fecha}</td>
                        <td>${jornada.nombre}</td>
                        <td>${jornada.licencia}</td>
                        <td>${jornada.inicio_jornada}</td>
                        <td>${jornada.fin_jornada}</td>
                        <td>${jornada.horas_efectivas}h</td>
                        <td>
                            <button class="btn btn-primary" onclick="verDetalleJornada(${jornada.id})">
                                Ver Detalle
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('jornadasTable').innerHTML = html;
        }

        async function loadLiquidaciones() {
            try {
                const response = await fetch('/api/liquidaciones');
                if (response.ok) {
                    const liquidaciones = await response.json();
                    displayLiquidaciones(liquidaciones);
                }
            } catch (error) {
                console.error('Error cargando liquidaciones:', error);
            }
        }

        function displayLiquidaciones(liquidaciones) {
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Taxista</th>
                            <th>Licencia</th>
                            <th>Turno</th>
                            <th>Recaudaci√≥n</th>
                            <th>Para Conductor</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            liquidaciones.forEach(liq => {
                html += `
                    <tr>
                        <td>${liq.fecha}</td>
                        <td>${liq.nombre}</td>
                        <td>${liq.licencia}</td>
                        <td>${liq.turno_realizado}</td>
                        <td>‚Ç¨ ${parseFloat(liq.recaudacion || 0).toFixed(2)}</td>
                        <td>‚Ç¨ ${parseFloat(liq.conductor || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-primary" onclick="verDetalleLiquidacion(${liq.id})">
                                Ver Detalle
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('liquidacionesTable').innerHTML = html;
        }

        async function loadUsuarios() {
            try {
                const response = await fetch('/api/usuarios');
                if (response.ok) {
                    const usuarios = await response.json();
                    displayUsuarios(usuarios);
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }

        function displayUsuarios(usuarios) {
            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>DNI</th>
                            <th>Nombre</th>
                            <th>Licencia</th>
                            <th>Propietario</th>
                            <th>Tipo</th>
                            <th>Fecha Registro</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            usuarios.forEach(usuario => {
                html += `
                    <tr>
                        <td>${usuario.dni}</td>
                        <td>${usuario.nombre}</td>
                        <td>${usuario.licencia}</td>
                        <td>${usuario.propietario}</td>
                        <td><span class="badge ${usuario.tipo === 'admin' ? 'badge-danger' : 'badge-primary'}">${usuario.tipo}</span></td>
                        <td>${new Date(usuario.created_at).toLocaleDateString('es-ES')}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('usuariosTable').innerHTML = html;
        }

        function handleFiles(files) {
            const listaArchivos = document.getElementById('listaArchivos');
            const archivosDiv = document.getElementById('archivosSubidos');
            
            listaArchivos.innerHTML = '';
            
            Array.from(files).forEach(file => {
                const li = document.createElement('li');
                li.textContent = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                listaArchivos.appendChild(li);
            });
            
            if (files.length > 0) {
                archivosDiv.classList.remove('hidden');
            }
        }

        async function procesarCierre() {
            const mes = document.getElementById('mescierre').value;
            const a√±o = document.getElementById('a√±ocierre').value;
            const usuarioId = document.getElementById('taxistaCierre').value;
            const archivos = document.getElementById('archivosInput').files;

            if (!mes || !a√±o || !usuarioId) {
                showMessage('Por favor, completa todos los campos requeridos.', 'error');
                return;
            }

            if (archivos.length === 0) {
                showMessage('Por favor, selecciona los archivos Excel necesarios.', 'error');
                return;
            }

            const procesarBtn = document.getElementById('procesarBtn');
            procesarBtn.disabled = true;
            procesarBtn.innerHTML = '<div class="loading"></div>Procesando...';

            try {
                // Subir archivos
                const formData = new FormData();
                formData.append('usuario_id', usuarioId);
                formData.append('mes', mes);
                formData.append('a√±o', a√±o);
                
                for (let i = 0; i < archivos.length; i++) {
                    formData.append('archivos', archivos[i]);
                }

                const uploadResponse = await fetch('/api/cierre-mensual/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('Error al subir archivos');
                }

                // Procesar cierre
                const procesarResponse = await fetch('/api/cierre-mensual/procesar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        usuario_id: usuarioId,
                        mes: mes,
                        a√±o: a√±o
                    })
                });

                const resultado = await procesarResponse.json();

                if (resultado.success) {
                    showMessage('‚úÖ Cierre mensual procesado correctamente', 'success');
                    mostrarResultadoCierre(resultado);
                } else {
                    showMessage(resultado.error || 'Error al procesar el cierre', 'error');
                }
            } catch (error) {
                showMessage('Error de conexi√≥n. Int√©ntalo de nuevo.', 'error');
                console.error('Error:', error);
            } finally {
                procesarBtn.disabled = false;
                procesarBtn.innerHTML = 'üßÆ Procesar Cierre Mensual';
            }
        }

        function mostrarResultadoCierre(resultado) {
            const resultadoDiv = document.getElementById('resultadoCierre');
            const detallesDiv = document.getElementById('detallesCierre');
            
            let html = `
                <div class="alert alert-success">
                    <strong>‚úÖ Cierre procesado exitosamente</strong><br>
                    ${resultado.mensaje}
                </div>
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-number">‚Ç¨ 12,450.50</div>
                        <div class="stat-label">Recaudaci√≥n Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">‚Ç¨ 5,602.25</div>
                        <div class="stat-label">Para Conductor</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-number">‚Ç¨ 6,848.25</div>
                        <div class="stat-label">Para Empresa</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="descargarCierre()">
                    üì• Descargar Informe PDF
                </button>
            `;
            
            detallesDiv.innerHTML = html;
            resultadoDiv.classList.remove('hidden');
        }

        async function generarReporte() {
            const tipo = document.getElementById('tipoReporte').value;
            const fechaInicio = document.getElementById('fechaInicioReporte').value;
            const fechaFin = document.getElementById('fechaFinReporte').value;

            showMessage('üîÑ Generando reporte...', 'info');

            try {
                // Simular generaci√≥n de reporte
                setTimeout(() => {
                    const reporteDiv = document.getElementById('reporteResultado');
                    const contenidoDiv = document.getElementById('contenidoReporte');
                    
                    let html = `
                        <div class="alert alert-success">
                            <strong>üìä Reporte ${tipo} generado</strong><br>
                            Per√≠odo: ${fechaInicio} - ${fechaFin}
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">‚Ç¨ 45,230.75</div>
                                <div class="stat-label">Recaudaci√≥n Total</div>
                            </div>
                            <div class="stat-card income">
                                <div class="stat-number">‚Ç¨ 20,353.84</div>
                                <div class="stat-label">Total Conductores</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-number">‚Ç¨ 24,876.91</div>
                                <div class="stat-label">Total Empresa</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="descargarReporte()">
                            üì• Descargar Reporte
                        </button>
                    `;
                    
                    contenidoDiv.innerHTML = html;
                    reporteDiv.classList.remove('hidden');
                    
                    showMessage('‚úÖ Reporte generado correctamente', 'success');
                }, 2000);
            } catch (error) {
                showMessage('Error al generar el reporte', 'error');
            }
        }

        function verDetalleJornada(id) {
            // Aqu√≠ cargar√≠as y mostrar√≠as los detalles de la jornada
            document.getElementById('modalContent').innerHTML = `
                <h3>üìÖ Detalle de Jornada #${id}</h3>
                <p><strong>Fecha:</strong> 2025-01-15</p>
                <p><strong>Taxista:</strong> Raul Maraver</p>
                <p><strong>Horario:</strong> 08:00 - 16:30</p>
                <p><strong>Descansos:</strong></p>
                <ul>
                    <li>10:30 - 10:45 (15 min)</li>
                    <li>14:00 - 14:30 (30 min)</li>
                </ul>
                <p><strong>Horas efectivas:</strong> 7h 45m</p>
                <div style="margin-top: 20px;">
                    <canvas width="300" height="150" style="border: 1px solid #ddd; border-radius: 5px;"></canvas>
                    <p style="text-align: center; margin-top: 10px; color: #666;">Firma digital del conductor</p>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }

        function verDetalleLiquidacion(id) {
            // Aqu√≠ cargar√≠as y mostrar√≠as los detalles de la liquidaci√≥n
            document.getElementById('modalContent').innerHTML = `
                <h3>üí∞ Detalle de Liquidaci√≥n #${id}</h3>
                <div class="form-grid">
                    <div><strong>Fecha:</strong> 2025-01-15</div>
                    <div><strong>Taxista:</strong> Ivan Alsina</div>
                    <div><strong>Licencia:</strong> 1061</div>
                    <div><strong>Turno:</strong> Ma√±ana</div>
                </div>
                <hr>
                <h4>üí∂ Ingresos</h4>
                <div class="form-grid">
                    <div>Recaudaci√≥n: <strong>‚Ç¨ 285.50</strong></div>
                    <div>Servicios Internos: <strong>‚Ç¨ 0.00</strong></div>
                    <div>Visas: <strong>‚Ç¨ 45.20</strong></div>
                    <div>Abonados: <strong>‚Ç¨ 12.30</strong></div>
                </div>
                <hr>
                <h4>üí∏ Gastos</h4>
                <div class="form-grid">
                    <div>Combustible: <strong>‚Ç¨ 35.00</strong></div>
                    <div>Gas: <strong>‚Ç¨ 0.00</strong></div>
                    <div>Otros: <strong>‚Ç¨ 5.50</strong></div>
                </div>
                <hr>
                <h4>üßÆ Resumen</h4>
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-number">‚Ç¨ 343.00</div>
                        <div class="stat-label">Total Ingresos</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-number">‚Ç¨ 40.50</div>
                        <div class="stat-label">Total Gastos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">‚Ç¨ 136.13</div>
                        <div class="stat-label">Para Conductor (45%)</div>
                    </div>
                </div>
            `;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function descargarCierre() {
            showMessage('üì• Preparando descarga del informe...', 'info');
            // Aqu√≠ implementar√≠as la descarga real
            setTimeout(() => {
                showMessage('‚úÖ Informe descargado correctamente', 'success');
            }, 2000);
        }

        function descargarReporte() {
            showMessage('üì• Preparando descarga del reporte...', 'info');
            // Aqu√≠ implementar√≠as la descarga real
            setTimeout(() => {
                showMessage('‚úÖ Reporte descargado correctamente', 'success');
            }, 2000);
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        function goBack() {
            window.location.href = '/';
        }

        // Cerrar modal si se hace clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Agregar algunos estilos CSS adicionales
        const additionalCSS = `
            .badge {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
                font-weight: bold;
            }
            .badge-primary {
                background: #3498db;
                color: white;
            }
            .badge-danger {
                background: #e74c3c;
                color: white;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalCSS;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>